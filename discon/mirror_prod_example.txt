mirror_registry=""
workspace=${PWD}/data_mirror_result
mkdir $workspace || exit 1

echo "# Check Environment"
if [[ $mirror_registry == "" ]]; then
    echo "Error: mirror_registry must be provided"
    exit 1
fi

echo "podman login $mirror_registry"
podman login $mirror_registry || exit 1
echo "podman login  registry.redhat.io"
podman login  registry.redhat.io || exit 1

echo "# Create ${workspace}/imageset.conf"
cat <<EOF >>${workspace}/imageset.conf
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v2alpha1
mirror:
  operators:
  - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.20
    packages:
    - name: cluster-operator
      channels:
      - name: stable-6.4
    - name: loki-operator
      channels:
      - name: stable-6.4
    - name: cluster-observability-operator
      channels:
      - name: stable
EOF

echo "#oc-mirror --v2 --config ${workspace}/imageset.conf --workspace file://${workspace} docker://${mirror_registry}"
oc-mirror --v2 --config ${workspace}/imageset.conf --workspace file://${workspace} docker://${mirror_registry}

echo "please create catalogsource and idms manually"
ls -d1 ${workspace}/working-dir/cluster-resources/
